## Join Server

The LoRa join server handles the registrations of LoRa devices according to LoRaWAN™ standard.

LoRa加入服务器根据LoRaWAN™标准处理LoRa设备的注册。

### OTAA vs ABP

LoRaWAN™ standard defines two ways of activation for LoRa devices, i.e., Over-The-Air Activation (OTAA) and Activation by Personalization (ABP). All LoRa devices must be activated in either way before access the network. 

LoRaWAN™标准定义了LoRa设备的两种激活方式，即空中激活（OTAA）和个性化激活（ABP）。 在访问网络之前，必须以任何一种方式激活所有LoRa设备。

In OTAA mode, LoRa devices only need to store AppEUI, DevEUI (or JoinEUI in LoRaWAN™ standard 1.1) and AppKey in their hardware. Then, these devices can issue activations by sending join request messages to servers. Some necessary parameters will be generated by server and respond via join accept messages. Some other data (e.g. session keys) are generated by both devices and server. These data are coincident since they use the same arguments and algorithms.

在OTAA模式下，LoRa设备仅需要在其硬件中存储AppEUI，DevEUI（或LoRaWAN™标准1.1中的JoinEUI）和AppKey。 然后，这些设备可以通过向服务器发送加入请求消息来发出激活信息。 服务器将生成一些必要的参数，并通过加入接受消息进行响应。 设备和服务器都会生成其他一些数据（例如会话密钥）。 这些数据是一致的，因为它们使用相同的参数和算法。

In ABP mode, all the necessary information is loaded in devices in the very beginning. These devices can interact with connector directly. Some previous operations need to be taken before enabling OTAA or adopting ABP to devices, please refer to Section 3.3.2 for more information.

在ABP模式下，所有必要的信息都从一开始就加载到设备中。 这些设备可以直接与连接器进行交互。 在启用OTAA或对设备采用ABP之前，需要执行一些先前的操作，有关更多信息，请参阅第3.3.2节。

### Functions

* **Activation**

   LoRa join server is only responsible for handling devices with OTAA mode. The ABP based devices can access the network directly. The join requests are parsed by connector first. Then, network server will forward the requests to join server via message queue under topic Join-sub. After receiving the requests, join server will generate some necessary data such as the unique identifier DevAddr for devices. The DevAddr contains the NetID for purpose of roaming. Two session keys, i.e., NwkSKey and AppSKey, are also calculated according to the protocol. Another part of the join procedure is to initialize some physical parameters of devices. The RX1DRoffset defines the offset between uplink data rate and downlink data rate at first reception slot. The Rx2 Data rate sets the data rate for second reception slot. Furthermore, the RxDelay configures the delay between TX and first reception slot. The scope of RxDelay varies from 0s to 15s. The details can be found in RXTimingSetupReq command. All these values are region specific and set to their default values during activation.

   LoRa加入服务器仅负责处理OTAA模式的设备。基于ABP的设备可以直接访问网络。连接请求首先解析连接请求。然后，网络服务器将通过主题Join-sub下的消息队列将请求转发到加入服务器。收到请求后，加入服务器将生成一些必要的数据，例如设备的唯一标识符DevAddr。 DevAddr包含用于漫游目的的NetID。还根据协议计算两个会话密钥，即NwkSKey和AppSKey。连接过程的另一部分是初始化设备的某些物理参数。 RX1DRoffset定义在第一个接收时隙的上行链路数据速率和下行链路数据速率之间的偏移量。 Rx2数据速率设置第二个接收时隙的数据速率。此外，RxDelay配置TX和第一个接收时隙之间的延迟。 RxDelay的范围从0s到15s不等。可以在RXTimingSetupReq命令中找到详细信息。所有这些值都是特定于区域的，并在激活期间设置为其默认值。

   Join server also needs to generate join accept messages for responses. These messages are published on topic *Join-pub* and network server needs to get them generally.

   加入服务器还需要生成加入接受消息以进行响应。 这些消息发布在主题* Join-pub *上，并且网络服务器通常需要获取它们。

* **Rejoin**

   **UNIMPLEMENTED**

### Interaction with LoRa Network Server

The LoRa join server subscribes the topic Join-sub to receive join requests from LoRa network server, and publishes join accept on topic Join-pub to LoRa network server. 

LoRa加入服务器订阅主题Join-sub以接收来自LoRa网络服务器的加入请求，并在主题Join-pub上将加入接受发布到LoRa网络服务器。

* **Network Server to Join Server**

```json
   { MHDR: { MType: 0, Major: 0 },
     MACPayload: {
       AppEUI: <Buffer 7b 80 60 6c af eb 0f 26>,
       DevEUI: <Buffer 37 b8 90 3b 37 b8 90 3b>,
       DevNonce: <Buffer 81 bf>,
     },
   },
```

* **Join Server to Network Server**

```json
   { MHDR: { MType: 1, Major: 0 },
     MACPayload:
     { AppNonce: <Buffer 32 dc 97>,
       NetID: <Buffer 00 00 00>,
       DevAddr: <Buffer 00 92 e1 96>,
       DLSettings: <Buffer c0>,
       RxDelay: <Buffer 01> },
   },
```

---
